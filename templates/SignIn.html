<!DOCTYPE html>
<html lang="en">
<head>
    
    <title>Login Page</title> 
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/static/signInStyles.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
</head>
<body>
<div class="container">
    <div class="page-header">
        <h1 style="text-align: center;">SCMXPertLite</h1>
        <div style="text-align: center;">
            <div style="text-align: center;">
                {% if success_message %}
                    <h2 style="color: rgb(77, 247, 10);">{{ success_message }}</h2>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="d-flex justify-content-center h-100">
        <div class="card">
            <div class="card-header">
                <h3 style="text-align: center;">Sign In</h3>
                <div style="text-align: center;">
                    {% if error_message %}
                        <p style="color: red;">{{ error_message }}</p>
                    {% endif %}
                    
                </div>
            </div>
            <div class="card-body">
                <form id="loginForm" action="/login" method="post" onsubmit="return validateForm()">
                    <div class="form-group">
                        <label for="username">Enter Username</label>
                        <input type="text" class="form-control" name="username" id="username" placeholder="Username">
                        <div id="usernameError" class="error"></div>
                    </div>
                    <div class="form-group">
                        <label for="password">Enter Password</label>
                        <input type="password" class="form-control" name="password" id="password" placeholder="Password" pattern="(?=.*\d)(?=.*[a-z])(?=.*[A-Z]).{8,}" title="Password must contain at least one number, one uppercase, one lowercase letter, and be at least 8 characters long" required>

                        <div id="passwordError" class="error"></div>
                        <div class="show-password">
                            <input type="checkbox" onclick="togglePasswordVisibility()"> Show Password
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="captcha">
                            <label for="captchaInput"></label>
                            <input type="text" class="form-control" name="captcha" id="captchaInput" placeholder="Enter CAPTCHA" autocomplete="off">
                            <img src="#" id="imgCaptcha" onclick="refreshCaptcha()" alt="CAPTCHA">
                            <button type="button" class="btn refresh_btn" onclick="refreshCaptcha()">Refresh</button>
                        </div>
                        <div id="captchaError" class="error"></div>
                    </div>
                    <div  class="text-center" class="form-group">
                        <input type="submit" value="Login" class="btn login_btn">
                    </div>
                </form>
            </div>
            <div class="card-footer">
                <div class="d-flex justify-content-center links">
                    Don't have an account? <a href="/sign_up">Sign Up</a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let currentCaptcha = "";

    function togglePasswordVisibility() {
        var passwordField = document.getElementById("password");
        if (passwordField.type === "password") {
            passwordField.type = "text";
        } else {
            passwordField.type = "password";
        }
    }

    function generateCaptcha() {
        let charsArray = "0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";
        let length = 6;
        let captcha = [];
        for (let i = 0; i < length; i++) {
            let index = Math.floor(Math.random() * charsArray.length); // Random index from charsArray
            captcha.push(charsArray[index]);
        }
        return captcha.join('');
    }

    function refreshCaptcha() {
        currentCaptcha = generateCaptcha();
        document.getElementById('imgCaptcha').src = 'data:image/png;base64,' + generateCaptchaImage(currentCaptcha);
        document.getElementById('imgCaptcha').alt = currentCaptcha;
        document.getElementById('captchaInput').value = '';
    }

    function generateCaptchaImage(captchaText) {
        let canvas = document.createElement('canvas');
        canvas.width = 100;
        canvas.height = 40;
        let ctx = canvas.getContext('2d');
        ctx.font = '24px Arial';
        ctx.fillStyle = 'black';
        ctx.textAlign = 'center';
        ctx.fillText(captchaText, canvas.width / 2, canvas.height / 2 + 8);
        return canvas.toDataURL('image/png').replace(/^data:image\/(png|jpg);base64,/, '');
    }

    function validateForm() {
        var isValid = true;

        var username = document.getElementById('username').value.trim();
        var password = document.getElementById('password').value.trim();
        var captchaInput = document.getElementById('captchaInput').value.trim();

        document.getElementById('usernameError').textContent = "";
        document.getElementById('passwordError').textContent = "";
        document.getElementById('captchaError').textContent = "";

        if (!username) {
            document.getElementById('usernameError').textContent = "Please fill out the username field.";
            isValid = false;
        }

        if (!password) {
            document.getElementById('passwordError').textContent = "Please fill out the password field.";
            isValid = false;
        }

        if (!captchaInput || captchaInput.toLowerCase() !== currentCaptcha.toLowerCase()) {
            document.getElementById('captchaError').textContent = "Please enter the CAPTCHA correctly.";
            isValid = false;
        }

        return isValid;
    }

    window.onload = function() {
        refreshCaptcha();
    };
</script>
</body>
</html>